<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title></title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <canvas></canvas>
        <img />
        <script src="gif.js"></script>
        <script src="gif.worker.js"></script>
        <script>
            let nFrames = 128;
            let width = 480;
            let height = 480;

            let rendered = false;
            let progress = 0; // 0 -> 1
            let bounce = 0; // 0 -> 1 -> 0
            let frameIndex = 0;

            let canvas = document.querySelector('canvas');
            let ctx = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;
            canvas.style.background = '#003554';

            let gif = new GIF({
                workers: 2,
                quality: 10
            });
            gif.on('finished', (blob) => {
                var img = document.querySelector('img');
                img.src = URL.createObjectURL(blob);
                rendered = true;
                canvas.style.display = 'none';
            });

            let nPrints = 5;
            let prints = [];

            for (let p = 0; p < nPrints; p++) {

                let extraL = 70 + Math.floor(Math.random() * 8) * 20;
                let L = height + extraL * 2;
                let dir = (Math.round(Math.random())) ? 1 : -1;
                let speed = L / nFrames * dir;
                let x = p * 120;
                let y = - extraL + Math.floor (Math.random() * L);
                let print = {
                    x, y, extraL, L, dir, speed
                };

                prints.push(print);
            }

            let draw = () => {
                ctx.save();
                ctx.fillStyle = '#C2EBFF';
                prints.forEach((print) => {
                    print.y += print.speed;
                    if (print.y < -print.extraL) {
                        print.y += print.L;
                    }
                    if (print.y > height + print.extraL) {
                        print.y -= print.L;
                    }
                    ctx.fillRect(print.x - 50, 0, 100, height);
                    ctx.fillRect(print.x - 70, print.y - 70, 140, 140);
                });
                ctx.fillStyle = '#003554';
                prints.forEach((print) => {
                    ctx.fillRect(print.x - 48, 0, 96, height);
                    ctx.fillRect(print.x - 68, print.y - 68, 136, 136);
                });
                ctx.fillStyle = '#C2EBFF';
                prints.forEach((print) => {
                    print.y += print.speed;
                    ctx.fillRect(print.x - 30, 0, 60, height);
                    ctx.fillRect(print.x - 50, print.y - 50, 100, 100);
                });
                ctx.fillStyle = '#003554';
                prints.forEach((print) => {
                    ctx.fillRect(print.x - 28, 0, 56, height);
                    ctx.fillRect(print.x - 48, print.y - 48, 96, 96);
                });
                ctx.fillStyle = '#C2EBFF';
                prints.forEach((print) => {
                    print.y += print.speed;
                    ctx.fillRect(print.x - 10, 0, 20, height);
                    ctx.fillRect(print.x - 30, print.y - 30, 60, 60);
                });
                ctx.fillStyle = '#003554';
                prints.forEach((print) => {
                    ctx.fillRect(print.x - 8, 0, 16, height);
                    ctx.fillRect(print.x - 28, print.y - 28, 56, 56);
                });
                ctx.restore();
            };

            let onF = () => {
                frameIndex = frameIndex + 1;
                progress = frameIndex / nFrames;
                bounce = 1 - Math.abs(1 - progress * 2);

                ctx.save();
                ctx.fillStyle = canvas.style.background;
                ctx.fillRect(0, 0, width, height);
                ctx.restore();

                draw();

                gif.addFrame(canvas, {
                    copy: true,
                    delay: 40
                });

                if (frameIndex < nFrames) {
                    requestAnimationFrame(onF);
                } else {
                    gif.render();
                }
            };
            onF();

        </script>
    </body>
</html>
