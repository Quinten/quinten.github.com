<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title></title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <canvas></canvas>
        <img />
        <script src="gif.js"></script>
        <script src="gif.worker.js"></script>
        <script>
            let nFrames = 64;
            let width = 507;
            let height = 507;

            let rendered = false;
            let progress = 0; // 0 -> 1
            let bounce = 0; // 0 -> 1 -> 0
            let frameIndex = 0;

            let canvas = document.querySelector('canvas');
            let ctx = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;
            canvas.style.background = '#f3f4eb';

            let gif = new GIF({
                workers: 2,
                quality: 5
            });
            gif.on('finished', (blob) => {
                var img = document.querySelector('img');
                img.src = URL.createObjectURL(blob);
                rendered = true;
                canvas.style.display = 'none';
            });

            let angleY = 0;

            let cosY = Math.cos(angleY);
            let sinY = Math.sin(angleY);

            let angleX = -Math.PI * 2 * Math.random();
            //let angleX = 0;
            let cosX = Math.cos(angleX);
            let sinX = Math.sin(angleX);

            let fl = 507;

            let p = [];
            let numPoints = 3600;
            let lineSize = 40;
            var Lx = 0, Ly = 0, Lz = 0;
            
            let s = [];
            let c = [];
            
            function addPole(x, z) {
                s.push({a: p.length, b: p.length + 1});
                p.push({x: x, y: -100, z: z});
                p.push({x: x, y: 100, z: z});
                
                s.push({a: p.length, b: p.length + 1});
                p.push({x: x - 20, y: -100, z: z});
                p.push({x: x + 20, y: -100, z: z});
                s.push({a: p.length, b: p.length - 2 });
                p.push({x: x - 20, y: -95, z: z});
                s.push({a: p.length, b: p.length - 2 });             
                p.push({x: x + 20, y: -95, z: z});
                c.push({a: p.length - 2, b: p.length + 2, c: p.length, d: p.length + 1});

                p.push({x: x - 120, y: -35, z: z + 100});
                p.push({x: x - 176, y: -35, z: z + 156});
                p.push({x: x - 276, y: -95, z: z + 256});
                c.push({a: p.length - 4, b: p.length + 2, c: p.length, d: p.length + 1});

                p.push({x: x - 80, y: -35, z: z + 100});
                p.push({x: x - 136, y: -35, z: z + 156});
                p.push({x: x - 236, y: -95, z: z + 256});
                
                s.push({a: p.length, b: p.length + 1});
                p.push({x: x - 20, y: -80, z: z});
                p.push({x: x + 20, y: -80, z: z});
                s.push({a: p.length, b: p.length - 2 });
                p.push({x: x - 20, y: -75, z: z});
                s.push({a: p.length, b: p.length - 2 });
                p.push({x: x + 20, y: -75, z: z});
                c.push({a: p.length - 2, b: p.length + 2, c: p.length, d: p.length + 1});

                p.push({x: x - 120, y: -15, z: z + 100});
                p.push({x: x - 176, y: -15, z: z + 156});
                p.push({x: x - 276, y: -75, z: z + 256});
                c.push({a: p.length - 4, b: p.length + 2, c: p.length, d: p.length + 1});

                p.push({x: x - 80, y: -15, z: z + 100});
                p.push({x: x - 136, y: -15, z: z + 156});
                p.push({x: x - 236, y: -75, z: z + 256});
                
                
                
            };
            
            addPole(256, -256);
            addPole(0, 0);
            addPole(-256, 256);
            addPole(-512, 512);
            addPole(-768, 768);

            let line = (x1, y1, x2, y2) => {
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }
            
            let curve = (x1, y1, cpx1, cpy1, cpx2, cpy2, x2, y2) => {
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.bezierCurveTo(cpx1, cpy1, cpx2, cpy2, x2, y2);
                ctx.stroke();
            }

            angleX = 0;
            angleY = 0;

            cosY = Math.cos(angleY);
            sinY = Math.sin(angleY);
            cosX = Math.cos(angleX);
            sinX = Math.sin(angleX);
            
            let speedX = 256 / nFrames;
            let speedZ = - 256 / nFrames;

            let draw = () => {
                ctx.save();
                ctx.strokeStyle = '#030422';
                ctx.lineWidth = 1;

                let vpX = width / 2;
                let vpY = height / 2;
                for (let i = 0; i < p.length; i++) {

                    let x1 = p[i].x * cosY - p[i].z * sinY;
                    let z1 = p[i].z * cosY + p[i].x * sinY;

                    let y1 = p[i].y * cosX - z1 * sinX;
                    let z2 = z1 * cosX + p[i].y * sinX;

                    p[i].x = x1 + speedX;
                    p[i].y = y1;
                    p[i].z = z2 + speedZ;

                    let scale = fl / (fl + p[i].z);
                    p[i]._x = vpX + p[i].x * scale;
                    p[i]._y = vpY + p[i].y * scale;
                }

                for (let i = 0; i < c.length; i++) {
                    let a = p[c[i].a];
                    let b = p[c[i].b];
                    let cp = p[c[i].c];
                    let d = p[c[i].d];
                    if (
                    //a.z < fl) && (b.z < fl) &&
                    (a.z > -fl) && (b.z > -fl) &&
                    !(((b._x < 0) && (a._x > width))
                    || ((b._x > width) && (a._x < 0))
                    || ((b._y < 0) && (a._y > height))
                    || ((b._y > height) && (a._y < 0))))
                    {
                        curve(a._x, a._y, cp._x, cp._y, d._x, d._y, b._x, b._y);
                    }
                }
                
                for (let i = 0; i < s.length; i++) {
                    let a = p[s[i].a];
                    let b = p[s[i].b];
                    if (
                    //a.z < fl) && (b.z < fl) &&
                    (a.z > -fl) && (b.z > -fl) &&
                    !(((b._x < 0) && (a._x > width))
                    || ((b._x > width) && (a._x < 0))
                    || ((b._y < 0) && (a._y > height))
                    || ((b._y > height) && (a._y < 0))))
                    {
                        line(b._x, b._y, a._x, a._y);
                    }
                }
            };

            let onF = () => {
                frameIndex = frameIndex + 1;
                progress = frameIndex / nFrames;
                bounce = 1 - Math.abs(1 - progress * 2);

                ctx.save();
                ctx.fillStyle = canvas.style.background;
                ctx.fillRect(0, 0, width, height);
                ctx.restore();

                draw();

                gif.addFrame(canvas, {
                    copy: true,
                    delay: 40
                });

                if (frameIndex < nFrames) {
                    requestAnimationFrame(onF);
                } else {
                    gif.render();
                }
            };
            onF();

        </script>
    </body>
</html>
