<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title></title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body>
        <canvas></canvas>
        <img />
        <script src="gif.js"></script>
        <script src="gif.worker.js"></script>
        <script>
            let nFrames = 128;
            let width = 600;
            let height = 600;

            let rendered = false;
            let progress = 0; // 0 -> 1
            let bounce = 0; // 0 -> 1 -> 0
            let frameIndex = 0;

            let canvas = document.querySelector('canvas');
            let ctx = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;
            canvas.style.background = '#ead8c8';

            let gif = new GIF({
                workers: 2,
                quality: 10
            });
            gif.on('finished', (blob) => {
                var img = document.querySelector('img');
                img.src = URL.createObjectURL(blob);
                rendered = true;
                canvas.style.display = 'none';
            });
            
            let x = 664;
            let speed = -768 / nFrames;

            let draw = () => {
                x += speed;
                ctx.save();
                ctx.strokeStyle = '#25222a';
                ctx.fillStyle = '#25222a';
                ctx.beginPath();
                ctx.moveTo(x, 480);
                ctx.lineTo(x+1, 360);
                ctx.lineTo(x+11, 360);
                ctx.lineTo(x+13, 365);
                ctx.lineTo(x+1, 365);
                ctx.closePath();
                ctx.stroke(); 
                ctx.restore();
            };

            let onF = () => {
                frameIndex = frameIndex + 1;
                progress = frameIndex / nFrames;
                bounce = 1 - Math.abs(1 - progress * 2);

                ctx.save();
                ctx.fillStyle = canvas.style.background;
                ctx.fillRect(0, 0, width, height);
                ctx.restore();

                draw();

                gif.addFrame(canvas, {
                    copy: true,
                    delay: 40
                });

                if (frameIndex < nFrames) {
                    requestAnimationFrame(onF);
                } else {
                    gif.render();
                }
            };
            onF();

        </script>
    </body>
</html>
